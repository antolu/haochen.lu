name: Integration Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  issues: write
  deployments: write

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set environment variables
      run: |
        echo "SECRET_KEY=integration-test-secret-key-min-32-chars" >> $GITHUB_ENV
        echo "SESSION_SECRET_KEY=integration-session-secret-min-32-chars" >> $GITHUB_ENV
        echo "ADMIN_PASSWORD=testpassword123" >> $GITHUB_ENV

    - name: Run integration tests
      run: |
        chmod +x test-integration.sh
        ./test-integration.sh -v

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          backend/test-results/
          backend/test-logs/
        retention-days: 7

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-coverage-report
        path: backend/test-results/htmlcov/
        retention-days: 7

    - name: Check coverage threshold
      if: success()
      run: |
        # Extract coverage percentage from pytest output
        # This is informational; adjust threshold as needed
        echo "Coverage report generated successfully"

    - name: Notify on failure
      if: failure() && github.event_name == 'schedule'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Integration Tests Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The scheduled integration tests have failed.

            **Run Details:**
            - Workflow: ${context.workflow}
            - Run ID: ${context.runId}
            - Commit: ${context.sha}
            - Logs: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            Please investigate the failures in the workflow logs and test results.`,
            labels: ['bug', 'ci/cd', 'integration-failure']
          });

  deployment-readiness:
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
    - name: Check deployment readiness
      run: |
        echo "âœ… Integration tests passed"
        echo "âœ… Ready for deployment to staging/production"

    - name: Notify deployment readiness
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
            environment: 'staging',
            description: 'Ready for staging deployment after successful integration tests',
            auto_merge: false,
            required_contexts: []
          });
